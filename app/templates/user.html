{% extends "/layout/sub/single_column.html" %}

{% from "/macros/common.html" import renderInlineList, renderList %}
{% from "/macros/nav.html" import pagination %}
{% from "/macros/review.html" import render_review %}
{% from "/macros/modal.html" import modal_render %}

{% block content_narrow_form %}

<div class="card" id="user_profile">
    <div class="card-header p-2">
        <h4 class="text-center">Profile Information
        <small><a href="" data-toggle="modal" data-target="#modal_message">(message)</a></small>
        {% if user == current_user %}    
        <small><a href="" data-toggle="modal" data-target="#modal_id">(edit)</a></small>
        {% endif %}

        </h4>
    </div>
    <div class="card-body">
        {# Only show user info if user is current user or friend/groups #}
        {% set common_groups = user.groups|select('in', current_user.groups)|list %}  
        {% set related = user in current_user.friends or user == current_user or common_groups|length > 0 %}

        {% if related %}
            <dl class="row">
                    {{ renderInlineList("Name", (user.full_name))}}
                    {{ renderInlineList("Username", user.username)}}
                    {{ renderInlineList("Email", user.email)}}
                    {{ renderInlineList("Address", renderList(["card-item", "card-item py-1 px-0"], user.address.line1,
                                                            user.address.line2,
                                                            ([user.address.city,
                                                            user.address.state.state_short,
                                                            user.address.zip]
                                                            |join(', '))
                                                            ))}}                            
            </dl>
        {% else %}
            <dl class="row">
                    {{ renderInlineList("Username", user.username)}}                          
            </dl>
        {% endif %}

        {% if user == current_user %}
            <br>
            <h4 class="text-center">Password</h4>
            <dl class="row">
                {% set pwd_date = user.password_set_date %}
                {{ renderInlineList("Last Updated", '%s-%s-%s'|format(pwd_date.month, pwd_date.day, pwd_date.year))}}
            </dl>
            <p class="card-item text-center">
            <a href="" data-toggle="modal" data-target="#modal_password">Click to update password</a></p>
        {% endif %}
    </div>
</div>

        <br>
<div class="card">
    <div class="card-header p-2">
        <h4 class="text-center"> Review Summary </h4>
    </div>
    <div class="card-body pb-0">
        <dl class="row">
            {{ renderInlineList( "# Reviews", summary.count)}}
            {% if reviews|length > 0 %}
                {{ renderInlineList("Avg Rating", summary.average|round(1))}}
            {% endif %}     
        </dl>
    </div>
</div>
        <br>
{% endblock %}

{% block content_medium %}
        <div id = "reviews">
                {%for review in reviews %}
                    {{render_review(review, current_user)}}
                    <br>
                {% endfor %}
        </div>

        {{pagination(pag_urls)}}
        
{% endblock %}

{% block modal %}

    {% if modal_open %}
        <script>$(window).on('load', function(){
            $("#modal_id").modal("show");
        });
        </script>
    {% endif %}

    {% if form %}
        {{modal_render(form, modal_title, action="/userupdate")}}
    {% endif %}


    {% if message %}
        {{modal_render(message, "Message", action="#", modalID = "modal_message") }}
        {% set msg_url = url_for('main.send_message') %} 
        <script>
        let submit_msg = document.getElementById("submit_msg")
        submit_msg.addEventListener("click", function(event){
            event.preventDefault();
            ajaxModalPost("{{url_for('main.send_message')}}",
                        "modal_message",
                        "Message sent",
                        "Message send failed.");
        })
        </script>
        {% endif %}

    {% if pword_open %}
        <script>$(window).on('load', function(){
            $("#modal_password").modal("show");
        });
        </script>
    {% endif %}    

    {% if pform %}
        {{modal_render(pform, modal_title_2, action="/passwordupdate", modalID="modal_password")}}
    {% endif %}
{% endblock%}

{% block jsScripts %}


{% endblock %}
